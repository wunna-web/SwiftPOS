<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwiftPOS Pro</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        darkd: '#2563eb',
                        ddarkark: '#0f172a',
                        surface: '#ffffff',
                        background: '#f1f5f9'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue.js 3 & Firebase -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .pop-enter-active { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #receipt, #receipt * { visibility: visible; }
            #receipt { position: absolute; left: 0; top: 0; width: 100%; margin: 0; }
            .no-print { display: none !important; }
        }

        /* Utility */
        .scrollbar-hide::--webkit-scrollbarwebkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "firebase/": "https://esm.sh/firebase@^12.7.0/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen w-screen overflow-hidden select-none">

    <div id="app" class="h-full w-full flex flex-col relative">

        <!-- GLOBAL TOASTS -->
        <div class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] w-full max-w-sm px-4 pointer-events-none flex flex-col gap-2">
            <transition-group name="fade">
                <div v-for="t in toasts" :key="t.id" 
                     :class="['px-4 py-3 rounded-xl shadow-xl text-white font-semibold flex items-center gap-3 pointer-events-auto backdrop-blur-md', 
                              t.type === 'error' ? 'bg-red-500/95' : t.type === 'success' ? 'bg-emerald-600/95' : 'bg-slate-800/95']">
                    <i :class="['fas', t.type === 'error' ? 'fa-circle-exclamation' : 'fa-check-circle']"></i>
                    {{ t.text }}
                </div>
            </transition-group>
        </div>

        <!-- ================= 1. DEVICE ACTIVATION (GOOGLE LOGIN) ================= -->
        <div v-if="viewState === 'DEVICE_LOGIN'" class="flex-1 flex flex-col items-center justify-center p-6 bg-white">
            <div class="w-24 h-24 bg-blue-600 rounded-3xl flex items-center justify-center shadow-blue-200 shadow-2xl mb-8 rotate-3">
                <i class="fas fa-store text-white text-4xl -rotate-3"></i>
            </div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">SwiftPOS Pro</h1>
            <p class="text-slate-500 mb-10 text-center max-w-xs">Owner Login<br>Activate this device to start selling.</p>
            <button @click="deviceLogin" :disabled="loading" class="w-full max-w-sm py-4 bg-white border-2 border-slate-100 hover:border-blue-500 rounded-2xl font-bold text-slate-700 flex items-center justify-center gap-3 transition-all active:scale-95 shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                {{ loading ? 'Activating...' : 'Activate Device' }}
            </button>
        </div>

        <!-- ================= 2. PIN LOCK SCREEN ================= -->
        <div v-else-if="viewState === 'PIN_LOCK'" class="flex-1 flex flex-col h-full bg-slate-900 text-white">
            <div class="flex-1 flex flex-col items-center justify-center p-6">
                <div class="mb-8 text-center">
                    <h2 class="text-2xl font-bold mb-1">Enter PIN</h2>
                    <p class="text-slate-400 text-sm">Access for {{ masterEmail }}</p>
                </div>
                
                <!-- PIN Dots -->
                <div class="flex gap-4 mb-10">
                    <div v-for="i in 4" :key="i" :class="['w-4 h-4 rounded-full transition-all', pinBuffer.length >= i ? 'bg-blue-500 scale-125' : 'bg-slate-700']"></div>
                </div>

                <!-- Numpad -->
                <div class="grid grid-cols-3 gap-4 w-full max-w-xs">
                    <button v-for="n in [1,2,3,4,5,6,7,8,9]" :key="n" @click="handlePinInput(n)" class="h-20 bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 active:bg-blue-600 active:text-white transition-colors">{{ n }}</button>
                    <button @click="viewState = 'DEVICE_LOGIN'; auth.signOut()" class="h-20 text-red-400 font-bold text-sm hover:bg-slate-800 rounded-2xl">LOGOUT</button>
                    <button @click="handlePinInput(0)" class="h-20 bg-slate-800 rounded-2xl text-2xl font-bold hover:bg-slate-700 active:bg-blue-600 active:text-white transition-colors">0</button>
                    <button @click="pinBuffer = pinBuffer.slice(0, -1)" class="h-20 text-slate-400 hover:bg-slate-800 rounded-2xl"><i class="fas fa-backspace text-xl"></i></button>
                </div>
            </div>
        </div>

        <!-- ================= 3. MAIN APP LAYOUT (POS / ADMIN) ================= -->
        <div v-else class="flex h-full overflow-hidden">
            
            <!-- Left View: POS -->
            <div v-if="viewState === 'POS'" class="flex-1 flex flex-col h-full relative bg-slate-100">
                <!-- Header -->
                <header class="bg-white px-4 py-3 shadow-sm z-20 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-3">
                        <div :class="['w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold', currentStaff.role === 'ADMIN' ? 'bg-purple-600' : 'bg-blue-600']">
                            {{ currentStaff.name[0] }}
                        </div>
                        <div>
                            <h1 class="font-bold leading-none">{{ currentStaff.name }}</h1>
                            <span class="text-xs text-slate-500">{{ currentStaff.role }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button v-if="currentStaff.role === 'ADMIN'" @click="viewState = 'ADMIN'" class="px-4 py-2 bg-slate-900 text-white text-sm font-bold rounded-lg hover:bg-slate-700">
                            Dashboard
                        </button>
                        <button @click="lockScreen" class="w-10 h-10 bg-slate-100 rounded-lg text-slate-600 hover:bg-red-50 hover:text-red-500">
                            <i class="fas fa-lock"></i>
                        </button>
                    </div>
                </header>

                <!-- Categories -->
                <div class="px-4 py-2 bg-white border-t border-slate-100 flex gap-2 overflow-x-auto scrollbar-hide shrink-0">
                    <button @click="selectedCategory = 'All'" 
                        :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors', selectedCategory === 'All' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600']">
                        All Items
                    </button>
                    <button v-for="cat in categories" :key="cat" @click="selectedCategory = cat"
                        :class="['px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors', selectedCategory === cat ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600']">
                        {{ cat }}
                    </button>
                </div>

                <!-- Product Grid -->
                <div class="flex-1 overflow-y-auto p-4 pb-32">
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                        <button v-for="p in filteredProducts" :key="p.id" @click="addToCart(p)"
                            class="bg-white p-3 rounded-2xl shadow-sm border border-transparent active:border-blue-500 active:scale-95 transition-all flex flex-col h-40 text-left relative overflow-hidden group">
                            
                            <div class="absolute top-2 right-2">
                                <span :class="['text-[10px] px-2 py-1 rounded-full font-bold', p.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">
                                    {{ p.stock }}
                                </span>
                            </div>

                            <div class="mt-auto">
                                <h3 class="font-bold text-slate-800 leading-tight mb-1 line-clamp-2">{{ p.name }}</h3>
                                <div class="flex justify-between items-end">
                                    <span class="text-blue-600 font-bold">${{ p.price }}</span>
                                    <span class="text-[10px] text-slate-400">{{ p.category }}</span>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Cart Bar (Bottom) -->
                <div v-if="cart.length > 0" class="fixed bottom-0 left-0 w-full p-4 z-30 pointer-events-none">
                    <button @click="showCheckout = true" class="pointer-events-auto w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl flex items-center justify-between active:scale-95 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">{{ cartCount }}</div>
                            <span class="font-bold text-lg">Checkout</span>
                        </div>
                        <span class="font-bold text-xl">${{ cartTotal }}</span>
                    </button>
                </div>
            </div>

            <!-- Full Screen Admin Dashboard -->
            <div v-if="viewState === 'ADMIN'" class="flex-1 bg-slate-50 flex flex-col h-full overflow-hidden">
                <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0">
                    <h1 class="font-bold text-lg">Admin Dashboard</h1>
                    <button @click="viewState = 'POS'" class="px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 text-sm font-bold">
                        Back to POS
                    </button>
                </header>

                <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                    <!-- 1. Daily Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <p class="text-xs text-slate-500 uppercase font-bold">Today's Sales</p>
                            <p class="text-2xl font-bold text-slate-900">${{ dailyStats.total.toFixed(2) }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <p class="text-xs text-slate-500 uppercase font-bold">Cash</p>
                            <p class="text-xl font-bold text-green-600">${{ dailyStats.cash.toFixed(2) }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <p class="text-xs text-slate-500 uppercase font-bold">KPay</p>
                            <p class="text-xl font-bold text-blue-600">${{ dailyStats.kpay.toFixed(2) }}</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <p class="text-xs text-slate-500 uppercase font-bold">Wave/CB</p>
                            <p class="text-xl font-bold text-purple-600">${{ dailyStats.other.toFixed(2) }}</p>
                        </div>
                    </div>

                    <!-- 2. Staff Management -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-lg">Staff & PINs</h2>
                            <button @click="toggleAddStaff" class="text-blue-600 text-sm font-bold">+ New Staff</button>
                        </div>
                        
                        <!-- Add Staff Form -->
                        <div v-if="showAddStaff" class="mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                <input v-model="newStaff.name" placeholder="Name" class="p-2 border rounded-lg text-sm">
                                <input v-model="newStaff.pin" placeholder="4-Digit PIN" maxlength="4" class="p-2 border rounded-lg text-sm">
                                <select v-model="newStaff.role" class="p-2 border rounded-lg text-sm">
                                    <option value="CASHIER">Cashier</option>
                                    <option value="ADMIN">Admin</option>
                                </select>
                                <button @click="addStaff" class="bg-blue-600 text-white rounded-lg font-bold text-sm">Create</button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                                    <tr><th class="p-3">Name</th><th class="p-3">Role</th><th class="p-3">PIN</th><th class="p-3 text-right">Action</th></tr>
                                </thead>
                                <tbody>
                                    <tr v-for="s in staffList" :key="s.id" class="border-b last:border-0">
                                        <td class="p-3 font-bold">{{ s.name }}</td>
                                        <td class="p-3"><span :class="['px-2 py-0.5 rounded text-xs font-bold', s.role==='ADMIN'?'bg-purple-100 text-purple-700':'bg-blue-100 text-blue-700']">{{ s.role }}</span></td>
                                        <td class="p-3 font-mono text-slate-400">****</td>
                                        <td class="p-3 text-right">
                                            <button @click="deleteStaff(s.id)" class="text-red-500 hover:text-red-700 font-bold" :disabled="s.id === currentStaff.id">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 3. Inventory Management -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-lg">Inventory</h2>
                            <button @click="toggleAddProduct" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold">+ New Product</button>
                        </div>

                        <!-- Add Product Form -->
                        <div v-if="showAddProduct" class="mb-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                             <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                                <input v-model="newProduct.name" placeholder="Product Name" class="col-span-2 p-2 border rounded-lg text-sm">
                                <input v-model.number="newProduct.price" type="number" placeholder="Price" class="p-2 border rounded-lg text-sm">
                                <input v-model.number="newProduct.stock" type="number" placeholder="Qty" class="p-2 border rounded-lg text-sm">
                                <input v-model="newProduct.category" list="catList" placeholder="Category" class="p-2 border rounded-lg text-sm">
                                <datalist id="catList"><option v-for="c in categories" :value="c"></option></datalist>
                                <input v-model="newProduct.barcode" placeholder="Barcode" class="col-span-full md:col-span-5 p-2 border rounded-lg text-sm">
                             </div>
                             <button @click="addProduct" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold">Save Product</button>
                        </div>

                        <div class="space-y-2">
                            <div v-for="p in products" :key="p.id" class="flex items-center justify-between p-3 border rounded-xl hover:bg-slate-50">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-800">{{ p.name }}</div>
                                    <div class="text-xs text-slate-500">{{ p.category }} | {{ p.barcode }}</div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <div class="font-bold">${{ p.price }}</div>
                                        <div :class="['text-xs font-bold', p.stock<5?'text-red-500':'text-green-600']">{{ p.stock }} left</div>
                                    </div>
                                    <button @click="quickRestock(p)" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 flex items-center justify-center font-bold">+</button>
                                    <button @click="deleteProduct(p.id)" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHECKOUT MODAL -->
            <transition name="slide-up">
                <div v-if="showCheckout" class="fixed inset-0 z-50 flex flex-col bg-white">
                    <div class="p-4 border-b flex items-center justify-between bg-slate-50">
                        <h2 class="font-bold text-xl">Review Order</h2>
                        <button @click="showCheckout = false" class="text-slate-500 hover:text-slate-800"><i class="fas fa-times text-xl"></i></button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div v-for="item in cart" :key="item.id" class="flex justify-between items-center p-3 border rounded-xl">
                            <div>
                                <div class="font-bold">{{ item.name }}</div>
                                <div class="text-sm text-slate-500">${{ item.price }} x {{ item.quantity }}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button @click="updateQty(item, -1)" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold">-</button>
                                <span class="font-bold w-4 text-center">{{ item.quantity }}</span>
                                <button @click="updateQty(item, 1)" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 border-t bg-slate-50">
                        <div class="flex justify-between items-end mb-6">
                            <span class="text-slate-500">Total Amount</span>
                            <span class="text-3xl font-bold text-slate-900">${{ cartTotal }}</span>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button @click="processPayment('Cash')" class="p-4 bg-green-100 text-green-800 font-bold rounded-xl hover:bg-green-200 border border-green-200">
                                <i class="fas fa-money-bill-wave mb-1 block text-xl"></i> Cash
                            </button>
                            <button @click="processPayment('KPay')" class="p-4 bg-blue-100 text-blue-800 font-bold rounded-xl hover:bg-blue-200 border border-blue-200">
                                <i class="fas fa-qrcode mb-1 block text-xl"></i> KPay
                            </button>
                            <button @click="processPayment('Wave')" class="p-4 bg-yellow-100 text-yellow-800 font-bold rounded-xl hover:bg-yellow-200 border border-yellow-200">
                                <i class="fas fa-mobile-alt mb-1 block text-xl"></i> Wave
                            </button>
                            <button @click="processPayment('CB Pay')" class="p-4 bg-orange-100 text-orange-800 font-bold rounded-xl hover:bg-orange-200 border border-orange-200">
                                <i class="fas fa-wallet mb-1 block text-xl"></i> CB Pay
                            </button>
                        </div>
                        <button @click="cart=[]" class="w-full py-3 text-red-500 font-bold text-sm">Clear Cart</button>
                    </div>
                </div>
            </transition>

        </div>

    </div>

    <!-- Hidden Receipt -->
    <div id="receipt" v-if="lastSale">
        <div class="text-center font-mono text-xs">
            <h1 class="text-lg font-bold mb-2">SWIFTPOS PRO</h1>
            <p>{{ new Date(lastSale.timestamp).toLocaleString() }}</p>
            <p>Ref: {{ lastSale.invoiceId }}</p>
            <p>Cashier: {{ lastSale.cashierName }}</p>
            <hr class="my-2 border-black border-dashed">
            <div v-for="i in lastSale.items" class="flex justify-between my-1">
                <span>{{ i.name }} x{{ i.quantity }}</span>
                <span>{{ (i.price * i.quantity).toFixed(2) }}</span>
            </div>
            <hr class="my-2 border-black border-dashed">
            <div class="flex justify-between font-bold text-sm">
                <span>TOTAL</span>
                <span>${{ lastSale.total.toFixed(2) }}</span>
            </div>
            <p class="mt-2 text-center">Paid via {{ lastSale.paymentMethod }}</p>
            <p class="mt-4 text-center">Thank You!</p>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION (EDIT ME)
        // ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBwH-4LerMWtszTDc8NQp3jzHPDjh0sW9Q",
    authDomain: "swiftpos-465f8.firebaseapp.com",
    projectId: "swiftpos-465f8",
    storageBucket: "swiftpos-465f8.firebasestorage.app",
    messagingSenderId: "1037723897244",
    appId: "1:1037723897244:web:a70a43c796949940038c59"
  };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence({ synchronizeTabs: true }).catch(console.warn);

        const { createApp, ref, computed, onMounted, watch } = Vue;

        // --- Audio Helper (Zero dependency) ---
        const playSound = (type) => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                if (type === 'beep') {
                    osc.frequency.value = 800;
                    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } else if (type === 'success') {
                    osc.frequency.setValueAtTime(500, ctx.currentTime);
                    osc.frequency.linearRampToValueAtTime(1000, ctx.currentTime + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                }
            } catch(e) {}
        };

        createApp({
            setup() {
                // States
                const viewState = ref('DEVICE_LOGIN'); // DEVICE_LOGIN, PIN_LOCK, POS, ADMIN
                const loading = ref(true);
                const masterEmail = ref('');
                const pinBuffer = ref('');
                const currentStaff = ref(null);
                
                // Data
                const products = ref([]);
                const staffList = ref([]);
                const cart = ref([]);
                const sales = ref([]);
                const toasts = ref([]);
                
                // UI
                const selectedCategory = ref('All');
                const showCheckout = ref(false);
                const showAddStaff = ref(false);
                const showAddProduct = ref(false);
                const lastSale = ref(null);

                // Forms
                const newStaff = ref({ name: '', pin: '', role: 'CASHIER' });
                const newProduct = ref({ name: '', price: '', stock: '', category: 'General', barcode: '' });

                // Computed
                const categories = computed(() => ['General', ...new Set(products.value.map(p => p.category))]);
                const filteredProducts = computed(() => {
                    if (selectedCategory.value === 'All') return products.value;
                    return products.value.filter(p => p.category === selectedCategory.value);
                });
                const cartTotal = computed(() => cart.value.reduce((sum, i) => sum + (i.price * i.quantity), 0).toFixed(2));
                const cartCount = computed(() => cart.value.reduce((sum, i) => sum + i.quantity, 0));

                const dailyStats = computed(() => {
                    const today = new Date().toDateString();
                    const todaySales = sales.value.filter(s => new Date(s.timestamp).toDateString() === today);
                    return {
                        total: todaySales.reduce((s, i) => s + i.total, 0),
                        cash: todaySales.filter(s => s.paymentMethod === 'Cash').reduce((s, i) => s + i.total, 0),
                        kpay: todaySales.filter(s => s.paymentMethod === 'KPay').reduce((s, i) => s + i.total, 0),
                        other: todaySales.filter(s => ['Wave','CB Pay'].includes(s.paymentMethod)).reduce((s, i) => s + i.total, 0)
                    };
                });

                // --- Init & Auth ---
                onMounted(() => {
                    auth.onAuthStateChanged(async (u) => {
                        loading.value = true;
                        if (u) {
                            masterEmail.value = u.email;
                            viewState.value = 'PIN_LOCK';
                            
                            // Initialize Real-time Listeners
                            db.collection('products').onSnapshot(snap => products.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
                            db.collection('staff').onSnapshot(snap => staffList.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
                            
                            // Fetch Sales for Admin
                            db.collection('sales').orderBy('timestamp', 'desc').limit(100).onSnapshot(snap => {
                                sales.value = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            });

                            // Ensure at least one Admin Staff exists for the owner
                            const staffSnap = await db.collection('staff').get();
                            if (staffSnap.empty) {
                                await db.collection('staff').add({
                                    name: 'Owner',
                                    pin: '0000',
                                    role: 'ADMIN',
                                    isActive: true
                                });
                                showToast('Default Admin PIN: 0000', 'success');
                            }
                        } else {
                            viewState.value = 'DEVICE_LOGIN';
                        }
                        loading.value = false;
                    });
                });

                const deviceLogin = async () => {
                    try {
                        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                    } catch(e) { showToast(e.message, 'error'); }
                };

                // --- PIN Logic ---
                const handlePinInput = (num) => {
                    if (pinBuffer.value.length < 4) {
                        pinBuffer.value += num;
                        if (pinBuffer.value.length === 4) validatePin();
                    }
                };

                const validatePin = () => {
                    const staff = staffList.value.find(s => s.pin === pinBuffer.value);
                    if (staff) {
                        currentStaff.value = staff;
                        viewState.value = 'POS';
                        playSound('success');
                        pinBuffer.value = '';
                    } else {
                        showToast('Invalid PIN', 'error');
                        pinBuffer.value = '';
                    }
                };

                const lockScreen = () => {
                    currentStaff.value = null;
                    viewState.value = 'PIN_LOCK';
                };

                // --- POS Actions ---
                const addToCart = (p) => {
                    if (p.stock <= 0) {
                        showToast('Out of Stock', 'error');
                        return;
                    }
                    const existing = cart.value.find(i => i.id === p.id);
                    if (existing) {
                        if (existing.quantity >= p.stock) {
                            showToast('Stock Limit Reached', 'error');
                            return;
                        }
                        existing.quantity++;
                    } else {
                        cart.value.push({ ...p, quantity: 1 });
                    }
                    playSound('beep');
                };

                const updateQty = (item, delta) => {
                    const newQ = item.quantity + delta;
                    if (newQ > item.stock) return showToast('Max Stock', 'error');
                    if (newQ < 1) cart.value = cart.value.filter(i => i.id !== item.id);
                    else item.quantity = newQ;
                };

                const processPayment = async (method) => {
                    loading.value = true;
                    try {
                        const saleData = {
                            invoiceId: 'INV-' + Date.now().toString().slice(-6),
                            items: JSON.parse(JSON.stringify(cart.value)),
                            total: parseFloat(cartTotal.value),
                            paymentMethod: method,
                            cashierName: currentStaff.value.name,
                            timestamp: Date.now()
                        };

                        await db.runTransaction(async (t) => {
                            const reads = await Promise.all(saleData.items.map(i => t.get(db.collection('products').doc(i.id))));
                            reads.forEach((doc, idx) => {
                                if (!doc.exists) throw "Item removed";
                                const stock = doc.data().stock;
                                const qty = saleData.items[idx].quantity;
                                if (stock < qty) throw `Insufficient stock: ${doc.data().name}`;
                                t.update(db.collection('products').doc(doc.id), { stock: stock - qty });
                            });
                            t.set(db.collection('sales').doc(), saleData);
                        });

                        playSound('success');
                        lastSale.value = saleData;
                        setTimeout(() => window.print(), 200);
                        cart.value = [];
                        showCheckout.value = false;
                        showToast('Sale Successful!', 'success');
                    } catch(e) {
                        showToast(e.message || e, 'error');
                    }
                    loading.value = false;
                };

                // --- Admin Actions ---
                const addStaff = async () => {
                    if (!newStaff.value.name || newStaff.value.pin.length !== 4) return showToast('Invalid details', 'error');
                    await db.collection('staff').add({ ...newStaff.value, isActive: true });
                    newStaff.value = { name: '', pin: '', role: 'CASHIER' };
                    showAddStaff.value = false;
                    showToast('Staff Added', 'success');
                };

                const deleteStaff = async (id) => {
                    if (confirm('Remove staff?')) await db.collection('staff').doc(id).delete();
                };

                const addProduct = async () => {
                    await db.collection('products').add(newProduct.value);
                    newProduct.value = { name: '', price: '', stock: '', category: 'General', barcode: '' };
                    showAddProduct.value = false;
                    showToast('Product Saved', 'success');
                };

                const deleteProduct = async (id) => {
                    if (confirm('Delete item?')) await db.collection('products').doc(id).delete();
                };

                const quickRestock = async (p) => {
                    const amt = prompt(`Add stock for ${p.name}:`, "10");
                    if (amt) {
                        await db.collection('products').doc(p.id).update({ stock: p.stock + parseInt(amt) });
                        showToast('Stock Updated', 'success');
                    }
                };

                // Utils
                const showToast = (text, type) => {
                    const id = Date.now();
                    toasts.value.push({ id, text, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };
                const toggleAddStaff = () => showAddStaff.value = !showAddStaff.value;
                const toggleAddProduct = () => showAddProduct.value = !showAddProduct.value;

                return {
                    viewState, loading, masterEmail, pinBuffer, currentStaff,
                    products, staffList, cart, cartTotal, cartCount, sales, dailyStats, toasts,
                    selectedCategory, categories, filteredProducts,
                    showCheckout, showAddStaff, showAddProduct, lastSale,
                    newStaff, newProduct,
                    deviceLogin, handlePinInput, lockScreen, auth,
                    addToCart, updateQty, processPayment,
                    addStaff, deleteStaff, addProduct, deleteProduct, quickRestock,
                    toggleAddStaff, toggleAddProduct
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
