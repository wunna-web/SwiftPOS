<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwiftPOS</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#22c55e',
                        danger: '#ef4444',
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue.js 3 (Global Build) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Firebase Compat Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* Touch optimization */
        body { -webkit-tap-highlight-color: transparent; }
        
        /* Print Styles */
        @media print {
            @page { margin: 0; size: auto; }
            body * { visibility: hidden; }
            #receipt, #receipt * { visibility: visible; }
            #receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                color: black;
            }
            .no-print { display: none !important; }
        }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(20px); opacity: 0; }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "firebase/": "https://esm.sh/firebase@^12.7.0/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-gray-100 text-slate-800 h-screen w-screen overflow-hidden select-none">

    <div id="app" class="h-full w-full flex flex-col relative">
        
        <!-- Toast Notifications -->
        <div class="fixed top-5 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 w-11/12 max-w-sm pointer-events-none">
            <transition-group name="slide-up">
                <div v-for="toast in toasts" :key="toast.id" 
                     :class="['px-4 py-3 rounded-lg shadow-xl text-white font-medium flex items-center gap-3 pointer-events-auto backdrop-blur-sm', 
                              toast.type === 'error' ? 'bg-red-600/90' : 
                              toast.type === 'success' ? 'bg-green-600/90' : 'bg-slate-800/90']">
                    <i :class="['fas', toast.type === 'error' ? 'fa-circle-exclamation' : 'fa-circle-check']"></i>
                    {{ toast.text }}
                </div>
            </transition-group>
        </div>

        <!-- ======================= 1. LOGIN VIEW ======================= -->
        <div v-if="currentView === 'LOGIN'" class="flex-1 flex flex-col items-center justify-center p-6 bg-slate-50">
            <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-xl text-center">
                <div class="bg-blue-600 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200">
                    <i class="fas fa-cash-register text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 mb-2">SwiftPOS</h1>
                <p class="text-slate-500 mb-8">Mobile Point of Sale</p>
                
                <button @click="login" :disabled="loading"
                    class="w-full py-3.5 px-4 bg-white border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-3 transition-all active:scale-95">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                    {{ loading ? 'Signing in...' : 'Continue with Google' }}
                </button>
            </div>
        </div>

        <!-- ======================= 2. POS HOME (PRODUCT SELECTION) ======================= -->
        <div v-else-if="currentView === 'POS_HOME'" class="flex-1 flex flex-col h-full bg-slate-100">
            <!-- Header -->
            <header class="bg-white px-4 py-3 shadow-sm z-10 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">
                        {{ user.email[0].toUpperCase() }}
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-800 leading-tight">SwiftPOS</h1>
                        <p class="text-xs text-slate-500">{{ isAdmin ? 'Admin' : 'Cashier' }}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button v-if="isAdmin" @click="currentView = 'ADMIN_PRODUCTS'" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg">
                        <i class="fas fa-cog text-lg"></i>
                    </button>
                    <button @click="logout" class="p-2 text-slate-500 hover:bg-red-50 hover:text-red-500 rounded-lg">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </button>
                </div>
            </header>

            <!-- Search Bar -->
            <div class="p-4 pb-2 bg-slate-100 sticky top-0 z-10">
                <div class="relative shadow-sm">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" v-model="searchQuery" ref="searchInput"
                        class="w-full pl-11 pr-4 py-3.5 rounded-xl border-none bg-white text-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        placeholder="Search or Scan...">
                </div>
            </div>

            <!-- Product Grid -->
            <div class="flex-1 overflow-y-auto p-4 pb-24">
                <div v-if="filteredProducts.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400">
                    <i class="fas fa-box-open text-4xl mb-2"></i>
                    <p>No products found</p>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <div v-for="product in filteredProducts" :key="product.id" @click="addToCart(product)"
                         class="bg-white p-3 rounded-xl shadow-sm border border-transparent active:border-blue-500 active:scale-95 transition-all flex flex-col h-auto min-h-[140px] relative overflow-hidden group">
                        
                        <!-- Stock Badge -->
                        <div class="absolute top-2 right-2">
                            <span :class="['text-[10px] px-2 py-1 rounded-full font-bold', product.stock > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700']">
                                {{ product.stock }}
                            </span>
                        </div>

                        <div class="flex-1 mt-4">
                            <h3 class="font-semibold text-slate-800 leading-tight mb-1 line-clamp-2">{{ product.name }}</h3>
                            <p class="text-xs text-slate-400 font-mono">{{ product.barcode }}</p>
                        </div>
                        
                        <div class="mt-3 flex items-end justify-between">
                            <span class="text-lg font-bold text-blue-600">${{ product.price.toFixed(2) }}</span>
                            <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Cart Bar -->
            <div v-if="cart.length > 0" class="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-slate-100 via-slate-100 to-transparent z-20">
                <button @click="currentView = 'POS_CART'" 
                    class="w-full bg-slate-900 text-white p-4 rounded-2xl shadow-xl shadow-slate-300 flex items-center justify-between active:scale-95 transition-transform">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                            {{ cartItemCount }}
                        </div>
                        <span class="font-medium">View Order</span>
                    </div>
                    <span class="font-bold text-xl">${{ cartTotal.toFixed(2) }}</span>
                </button>
            </div>
        </div>

        <!-- ======================= 3. POS CART (REVIEW) ======================= -->
        <div v-else-if="currentView === 'POS_CART'" class="flex-1 flex flex-col h-full bg-white">
            <!-- Header -->
            <header class="px-4 py-4 border-b flex items-center gap-4 bg-white sticky top-0 z-10">
                <button @click="currentView = 'POS_HOME'" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold">Current Order</h1>
                <div class="ml-auto">
                     <button @click="cart = []; currentView = 'POS_HOME'" class="text-red-500 text-sm font-medium px-3 py-1 rounded hover:bg-red-50">Clear</button>
                </div>
            </header>

            <!-- Cart List -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div v-for="item in cart" :key="item.id" class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-800">{{ item.name }}</h4>
                        <p class="text-sm text-slate-500">${{ item.price.toFixed(2) }} / unit</p>
                    </div>
                    <div class="flex items-center bg-white rounded-lg shadow-sm border border-slate-200">
                        <button @click="updateQty(item, -1)" class="w-10 h-10 flex items-center justify-center text-slate-600 active:bg-slate-100 rounded-l-lg">
                            <i class="fas fa-minus text-sm"></i>
                        </button>
                        <span class="w-8 text-center font-bold text-slate-800">{{ item.quantity }}</span>
                        <button @click="updateQty(item, 1)" class="w-10 h-10 flex items-center justify-center text-slate-600 active:bg-slate-100 rounded-r-lg">
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-end mb-6">
                    <span class="text-slate-500 font-medium">Total Amount</span>
                    <span class="text-3xl font-bold text-slate-900">${{ cartTotal.toFixed(2) }}</span>
                </div>
                
                <button @click="checkout" :disabled="loading" 
                    class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 flex items-center justify-center gap-2 active:bg-blue-700 disabled:opacity-70 disabled:cursor-not-allowed">
                    <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i> Processing...</span>
                    <span v-else>Confirm Payment <i class="fas fa-check ml-1"></i></span>
                </button>
            </div>
        </div>

        <!-- ======================= 4. POS SUCCESS ======================= -->
        <div v-else-if="currentView === 'POS_SUCCESS'" class="flex-1 flex flex-col items-center justify-center p-8 bg-white text-center">
            <div class="w-24 h-24 rounded-full bg-green-100 text-green-500 flex items-center justify-center mb-6 animate-bounce">
                <i class="fas fa-check text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-900 mb-2">Order Successful!</h2>
            <p class="text-slate-500 mb-8">Invoice #{{ lastSale?.invoiceId }}</p>
            
            <div class="w-full max-w-sm space-y-3">
                <button @click="window.print()" class="w-full py-3.5 border-2 border-slate-200 rounded-xl font-bold text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
                <button @click="startNewSale" class="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold shadow-lg shadow-slate-200 hover:bg-slate-800">
                    New Sale
                </button>
            </div>
        </div>

        <!-- ======================= 5. ADMIN SECTION ======================= -->
        <div v-else-if="currentView.startsWith('ADMIN')" class="flex-1 flex flex-col h-full bg-slate-100">
            <!-- Admin Header -->
            <header class="bg-slate-900 text-white px-4 py-3 shadow-lg z-10 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <button @click="currentView = 'POS_HOME'" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600">
                        <i class="fas fa-times"></i>
                    </button>
                    <span class="font-bold">Admin Panel</span>
                </div>
                <div class="flex gap-1 bg-slate-800 p-1 rounded-lg">
                    <button @click="currentView = 'ADMIN_PRODUCTS'" :class="['px-3 py-1 rounded text-sm font-medium', currentView === 'ADMIN_PRODUCTS' ? 'bg-blue-600 text-white' : 'text-slate-400']">Items</button>
                    <button @click="currentView = 'ADMIN_SALES'" :class="['px-3 py-1 rounded text-sm font-medium', currentView === 'ADMIN_SALES' ? 'bg-blue-600 text-white' : 'text-slate-400']">Sales</button>
                    <button @click="currentView = 'ADMIN_USERS'" :class="['px-3 py-1 rounded text-sm font-medium', currentView === 'ADMIN_USERS' ? 'bg-blue-600 text-white' : 'text-slate-400']">Users</button>
                </div>
            </header>

            <!-- Admin Content -->
            <div class="flex-1 overflow-y-auto p-4">
                
                <!-- Products View -->
                <div v-if="currentView === 'ADMIN_PRODUCTS'">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                        <h3 class="font-bold mb-3 text-slate-800">Add New Product</h3>
                        <form @submit.prevent="addProduct" class="space-y-3">
                            <input v-model="newProduct.name" required placeholder="Product Name" class="w-full p-3 bg-slate-50 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="flex gap-3">
                                <input v-model.number="newProduct.price" type="number" step="0.01" required placeholder="Price" class="w-1/2 p-3 bg-slate-50 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                                <input v-model.number="newProduct.stock" type="number" required placeholder="Stock" class="w-1/2 p-3 bg-slate-50 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="relative">
                                <i class="fas fa-barcode absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input v-model="newProduct.barcode" required placeholder="Scan Barcode" class="w-full pl-10 p-3 bg-slate-50 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">Add Product</button>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div v-for="p in products" :key="p.id" class="p-4 border-b last:border-0 flex justify-between items-center">
                            <div>
                                <div class="font-bold text-slate-800">{{ p.name }}</div>
                                <div class="text-xs text-slate-500">{{ p.barcode }}</div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <div class="font-bold">${{ p.price.toFixed(2) }}</div>
                                    <div :class="['text-xs font-bold', p.stock < 5 ? 'text-red-500' : 'text-green-600']">{{ p.stock }} in stock</div>
                                </div>
                                <button @click="deleteProduct(p.id)" class="w-8 h-8 rounded bg-red-50 text-red-500 flex items-center justify-center">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales View -->
                <div v-if="currentView === 'ADMIN_SALES'">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden divide-y">
                         <div v-for="s in salesHistory" :key="s.id" class="p-4 flex justify-between items-center">
                             <div>
                                 <div class="font-bold text-slate-800">{{ s.invoiceId }}</div>
                                 <div class="text-xs text-slate-500">{{ new Date(s.timestamp).toLocaleDateString() }}</div>
                             </div>
                             <div class="text-right flex items-center gap-3">
                                 <div class="font-bold text-lg">${{ s.total.toFixed(2) }}</div>
                                 <button @click="printExistingSale(s)" class="w-8 h-8 bg-blue-50 text-blue-600 rounded flex items-center justify-center">
                                     <i class="fas fa-print"></i>
                                 </button>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- Users View -->
                <div v-if="currentView === 'ADMIN_USERS'">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden divide-y">
                        <div v-for="u in usersList" :key="u.uid" class="p-4 flex justify-between items-center">
                            <div>
                                <div class="font-bold text-slate-800 break-all">{{ u.email }}</div>
                                <span :class="['px-2 py-0.5 rounded text-[10px] uppercase font-bold', u.role === 'ADMIN' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700']">
                                    {{ u.role }}
                                </span>
                            </div>
                            <button v-if="u.uid !== user.uid" @click="toggleRole(u)" class="text-sm font-medium text-blue-600 px-3 py-1 bg-blue-50 rounded">
                                {{ u.role === 'ADMIN' ? 'Demote' : 'Promote' }}
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Hidden Receipt Template -->
    <div id="receipt" v-if="lastSale">
        <div class="text-center mb-4">
            <h1 class="text-xl font-bold uppercase">SwiftPOS Store</h1>
            <p class="text-sm">123 Market Street, City</p>
            <p class="text-sm">Tel: (555) 019-2834</p>
        </div>
        <div class="border-b-2 border-dashed border-black mb-2 pb-2 text-sm">
            <p><strong>Inv:</strong> {{ lastSale.invoiceId }}</p>
            <p><strong>Date:</strong> {{ new Date(lastSale.timestamp).toLocaleString() }}</p>
            <p><strong>Cashier:</strong> {{ lastSale.cashierEmail }}</p>
        </div>
        <table class="w-full text-sm mb-4">
            <tr v-for="item in lastSale.items" :key="item.id">
                <td class="py-1">{{ item.name }}</td>
                <td class="text-right">x{{ item.quantity }}</td>
                <td class="text-right">${{ (item.price * item.quantity).toFixed(2) }}</td>
            </tr>
        </table>
        <div class="border-t-2 border-dashed border-black pt-2 mb-8">
            <div class="flex justify-between font-bold text-lg">
                <span>TOTAL</span>
                <span>${{ lastSale.total.toFixed(2) }}</span>
            </div>
        </div>
        <div class="text-center text-sm">
            <p>Thank you for shopping!</p>
        </div>
    </div>

    <script>
        // -------------------------------------------------------------
        // PASTE YOUR FIREBASE CONFIGURATION HERE
        // -------------------------------------------------------------
        const firebaseConfig = {
    apiKey: "AIzaSyBwH-4LerMWtszTDc8NQp3jzHPDjh0sW9Q",
    authDomain: "swiftpos-465f8.firebaseapp.com",
    projectId: "swiftpos-465f8",
    storageBucket: "swiftpos-465f8.firebasestorage.app",
    messagingSenderId: "1037723897244",
    appId: "1:1037723897244:web:a70a43c796949940038c59"
  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Enable Offline Persistence
        db.enablePersistence({ synchronizeTabs: true }).catch(err => {
            console.log('Persistence disabled:', err.code);
        });

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // Core State
                const user = ref(null);
                const userRole = ref('CASHIER');
                const loading = ref(true);
                const currentView = ref('LOGIN'); // Values: LOGIN, POS_HOME, POS_CART, POS_SUCCESS, ADMIN_*
                
                // Data
                const products = ref([]);
                const cart = ref([]);
                const searchQuery = ref('');
                const toasts = ref([]);
                const lastSale = ref(null);
                const salesHistory = ref([]);
                const usersList = ref([]);
                const newProduct = ref({ name: '', price: '', stock: '', barcode: '' });
                const searchInput = ref(null);

                // Computed
                const isAdmin = computed(() => userRole.value === 'ADMIN');
                
                const filteredProducts = computed(() => {
                    const q = searchQuery.value.toLowerCase();
                    return products.value.filter(p => 
                        p.name.toLowerCase().includes(q) || 
                        p.barcode.includes(q)
                    );
                });

                const cartTotal = computed(() => 
                    cart.value.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                );

                const cartItemCount = computed(() => 
                    cart.value.reduce((sum, item) => sum + item.quantity, 0)
                );

                // Notifications
                const showToast = (text, type = 'info') => {
                    const id = Date.now();
                    toasts.value.push({ id, text, type });
                    setTimeout(() => {
                        toasts.value = toasts.value.filter(t => t.id !== id);
                    }, 3000);
                };

                // Authentication & Setup
                onMounted(() => {
                    auth.onAuthStateChanged(async (u) => {
                        loading.value = true;
                        if (u) {
                            user.value = u;
                            const userRef = db.collection('users').doc(u.uid);
                            const docSnap = await userRef.get();
                            
                            if (docSnap.exists) {
                                userRole.value = docSnap.data().role;
                            } else {
                                const allUsers = await db.collection('users').get();
                                const role = allUsers.empty ? 'ADMIN' : 'CASHIER';
                                await userRef.set({ email: u.email, role, uid: u.uid });
                                userRole.value = role;
                            }
                            
                            db.collection('products').onSnapshot(snap => {
                                products.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            });

                            if (currentView.value === 'LOGIN') currentView.value = 'POS_HOME';
                        } else {
                            user.value = null;
                            currentView.value = 'LOGIN';
                        }
                        loading.value = false;
                    });

                    // Barcode Scanner Listener
                    let buffer = '';
                    let lastKeyTime = Date.now();
                    window.addEventListener('keydown', (e) => {
                        if (currentView.value !== 'POS_HOME') return;

                        // Calculate typing speed to distinguish scanner
                        const now = Date.now();
                        const isFast = (now - lastKeyTime) < 50;
                        
                        // If focusing input, let browser handle, unless it's obviously a scanner (very fast)
                        if (document.activeElement === searchInput.value && !isFast) return;

                        if (now - lastKeyTime > 100) buffer = '';
                        lastKeyTime = now;

                        if (e.key === 'Enter' && buffer.length > 2) {
                            const product = products.value.find(p => p.barcode === buffer);
                            if (product) {
                                addToCart(product);
                                buffer = '';
                                if (document.activeElement === searchInput.value) searchQuery.value = '';
                            }
                        } else if (e.key.length === 1) {
                            buffer += e.key;
                        }
                    });
                });

                // --- Auth Actions ---
                const login = async () => {
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await auth.signInWithPopup(provider);
                    } catch (e) {
                        showToast('Login Failed', 'error');
                    }
                };

                const logout = () => auth.signOut();

                // --- POS Actions ---
                const addToCart = (product) => {
                    if (product.stock <= 0) {
                        showToast('Out of Stock', 'error');
                        return;
                    }
                    const existing = cart.value.find(i => i.id === product.id);
                    if (existing) {
                        if (existing.quantity >= product.stock) {
                            showToast('Max stock reached', 'error');
                            return;
                        }
                        existing.quantity++;
                    } else {
                        cart.value.push({ ...product, quantity: 1 });
                    }
                    showToast('Added to cart', 'success');
                };

                const updateQty = (item, delta) => {
                    const newQty = item.quantity + delta;
                    if (newQty > item.stock) {
                        showToast('Not enough stock', 'error');
                        return;
                    }
                    if (newQty < 1) {
                        cart.value = cart.value.filter(i => i.id !== item.id);
                        if (cart.value.length === 0) currentView.value = 'POS_HOME';
                        return;
                    }
                    item.quantity = newQty;
                };

                // CRITICAL FIX: Robust Checkout Logic
                const checkout = async () => {
                    if (cart.value.length === 0) return;
                    loading.value = true;

                    try {
                        // 1. Prepare Data
                        const saleData = {
                            invoiceId: 'INV-' + Date.now().toString().slice(-6),
                            items: JSON.parse(JSON.stringify(cart.value)), // Deep copy to prevent mutation issues
                            total: cartTotal.value,
                            cashierEmail: user.value.email,
                            timestamp: Date.now()
                        };

                        // 2. Run Firestore Transaction
                        await db.runTransaction(async (transaction) => {
                            // Read Phase
                            const productRefs = saleData.items.map(item => db.collection('products').doc(item.id));
                            const productDocs = await Promise.all(productRefs.map(ref => transaction.get(ref)));

                            // Validation & Logic Phase
                            productDocs.forEach((doc, idx) => {
                                if (!doc.exists) throw new Error(`Product removed: ${saleData.items[idx].name}`);
                                
                                const serverStock = doc.data().stock;
                                const reqQty = saleData.items[idx].quantity;
                                
                                if (serverStock < reqQty) {
                                    throw new Error(`Insufficient stock: ${doc.data().name} (Only ${serverStock} left)`);
                                }

                                // Write Phase (Stage updates)
                                transaction.update(productRefs[idx], { stock: serverStock - reqQty });
                            });

                            // Create Sale Record
                            const saleRef = db.collection('sales').doc();
                            transaction.set(saleRef, saleData);
                        });

                        // 3. Success Handling
                        lastSale.value = saleData;
                        cart.value = [];
                        currentView.value = 'POS_SUCCESS';
                        showToast('Payment Successful', 'success');

                    } catch (e) {
                        console.error(e);
                        showToast(e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const startNewSale = () => {
                    cart.value = [];
                    currentView.value = 'POS_HOME';
                    nextTick(() => searchInput.value?.focus());
                };

                // --- Admin Actions ---
                watch(currentView, async (newView) => {
                    if (newView === 'ADMIN_SALES' && isAdmin.value) {
                        const snap = await db.collection('sales').orderBy('timestamp', 'desc').limit(50).get();
                        salesHistory.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    }
                    if (newView === 'ADMIN_USERS' && isAdmin.value) {
                        const snap = await db.collection('users').get();
                        usersList.value = snap.docs.map(d => d.data());
                    }
                });

                const addProduct = async () => {
                    try {
                        await db.collection('products').add({ ...newProduct.value, last_updated: Date.now() });
                        showToast('Product Created', 'success');
                        newProduct.value = { name: '', price: '', stock: '', barcode: '' };
                    } catch (e) { showToast(e.message, 'error'); }
                };

                const deleteProduct = async (id) => {
                    if(!confirm('Delete this product?')) return;
                    await db.collection('products').doc(id).delete();
                };

                const toggleRole = async (u) => {
                    const newRole = u.role === 'ADMIN' ? 'CASHIER' : 'ADMIN';
                    await db.collection('users').doc(u.uid).update({ role: newRole });
                    u.role = newRole; // Optimistic update
                };

                const printExistingSale = (sale) => {
                    lastSale.value = sale;
                    setTimeout(() => window.print(), 100);
                };

                return {
                    user, userRole, isAdmin, loading, currentView,
                    products, filteredProducts, cart, cartTotal, cartItemCount,
                    searchQuery, toasts, searchInput,
                    login, logout, addToCart, updateQty, checkout, startNewSale,
                    newProduct, addProduct, deleteProduct,
                    usersList, toggleRole,
                    lastSale, salesHistory, printExistingSale
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
